"use strict";var _slicedToArray=function(r,e){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return function(r,e){var t=[],n=!0,i=!1,o=void 0;try{for(var a,s=r[Symbol.iterator]();!(n=(a=s.next()).done)&&(t.push(a.value),!e||t.length!==e);n=!0);}catch(r){i=!0,o=r}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return t}(r,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},fs=require("fs"),path=require("path"),prompt=require("readline-sync"),md5=require("md5"),mkdirp=require("mkdirp"),_require=require("./interface"),showMessage=_require.showMessage,showError=_require.showError,errors=_require.errors,delimiters={main:"@@@[0]@@@",files:"@@@[1]@@@",data:"@@@[2]@@@"},getHexFromByte=function(r){return("0"+r.toString(16)).slice(-2)},getByteFromHex=function(r){return parseInt(r,16)},transforms=[{code:"1.0",transform:function(t){return new Array(t.length).fill("").map(function(r,e){return getHexFromByte(t[e])}).reduce(function(r,e){return r+e},"")},recover:function(t){return Buffer.from(new Array(t.length/2).fill("").map(function(r,e){return getByteFromHex(t.substr(2*e,2))}))}}],liftPath=function(r){return r.split("/").filter(function(r){return".."!==r}).join("/")},getFinalFilePaths=function(r,e){return r.map(function(r){return path.join(e,r)})},encryptOrDecryptText=function(r,t){return t?r.split("").map(function(r,e){return String.fromCharCode(r.charCodeAt(0)^t.charCodeAt(e%t.length))}).join(""):r};module.exports.doIt=function(r,e){var t=transforms.length-1,n=transforms[t],i=n.code,o=n.transform,a=prompt.question("Enter a password if you want to use one: ",{hideEchoBack:!0}),s=i+","+(a&&md5(a)),u=r.map(function(r){return""+liftPath(r)+delimiters.data+o(fs.readFileSync(r))}).join(delimiters.files),c=encryptOrDecryptText(u,a);showMessage(r.length,"input files provided"),fs.writeFileSync(e,s+delimiters.main+c),showMessage("Data re-written at",e)},module.exports.undoIt=function(r,e){var t=fs.readFileSync(r).toString().split(delimiters.main),n=t[0].split(","),i=_slicedToArray(n,2),o=i[0],a=i[1],s=transforms.filter(function(r){return r.code===o})[0];s||showError(errors.UNRECOGNIZED_TRANSFORM);var u=s.recover,c=a?prompt.question("Enter a password to (un)re-write: ",{hideEchoBack:!0}):"";a&&a!==md5(c)&&showError(errors.INCORRECT_PASSWORD);var f=encryptOrDecryptText(t[1],c).split(delimiters.files).map(function(r){var e=r.split(delimiters.data),t=_slicedToArray(e,2),n=t[0],i=t[1];return{name:n,content:u(i)}}),l=f.map(function(r){return r.name}),d=getFinalFilePaths(l,e);showMessage(d.length,"files to be (un)re-written"),d.forEach(function(r,e){mkdirp.sync(path.dirname(r)),fs.writeFileSync(r,f[e].content)}),showMessage("(Un)re-written data placed at",e)};