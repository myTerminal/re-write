"use strict";var _slicedToArray=function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return function(r,t){var e=[],n=!0,i=!1,o=void 0;try{for(var a,s=r[Symbol.iterator]();!(n=(a=s.next()).done)&&(e.push(a.value),!t||e.length!==t);n=!0);}catch(r){i=!0,o=r}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return e}(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},fs=require("fs"),path=require("path"),prompt=require("readline-sync"),md5=require("md5"),mkdirp=require("mkdirp"),io=require("./interface"),delimiters={main:"<{([0])}>",files:"<{([1])}>",data:"<{([2])}>"},transforms=[{transform:function(e){return new Array(e.length).fill("").map(function(r,t){return getHexFromByte(e[t])}).reduce(function(r,t){return r+t},"")},recover:function(e){return Buffer.from(new Array(e.length/2).fill("").map(function(r,t){return getByteFromHex(e.substr(2*t,2))}))}}],getHexFromByte=function(r){return("0"+r.toString(16)).slice(-2)},getByteFromHex=function(r){return parseInt(r,16)},liftPath=function(r){return r.split("/").filter(function(r){return".."!==r}).join("/")},getFinalFilePaths=function(r,t){return r.map(function(r){return path.join(t,r)})},encryptOrDecryptText=function(r,e){return e?r.split("").map(function(r,t){return String.fromCharCode(r.charCodeAt(0)^e.charCodeAt(t%e.length))}).join(""):r};module.exports.doIt=function(r,t){var e=transforms.length-1,n=transforms[e].transform,i=prompt.question("Enter a password if you want to use one: ",{hideEchoBack:!0}),o=e+","+(i&&md5(i)),a=r.map(function(r){return""+liftPath(r)+delimiters.data+n(fs.readFileSync(r))}).join(delimiters.files),s=encryptOrDecryptText(a,i);io.showMessage(r.length,"input files provided"),fs.writeFileSync(t,o+delimiters.main+s),io.showMessage("Data re-written at",t)},module.exports.undoIt=function(r,t){var e=fs.readFileSync(r).toString().split(delimiters.main),n=e[0].split(","),i=_slicedToArray(n,2),o=i[0],a=i[1],s=transforms[+o].recover,u=a?prompt.question("Enter a password to (un)re-write: ",{hideEchoBack:!0}):"";a&&a!==md5(u)&&io.showError("INCORRECT_PASSWORD");var c=encryptOrDecryptText(e[1],u).split(delimiters.files).map(function(r){var t=r.split(delimiters.data);return{name:t[0],content:s(t[1])}}),f=c.map(function(r){return r.name}),l=getFinalFilePaths(f,t);io.showMessage(l.length,"files to be (un)re-written"),l.forEach(function(r,t){mkdirp.sync(path.dirname(r)),fs.writeFileSync(r,c[t].content)}),io.showMessage("(Un)re-written data placed at",t)};