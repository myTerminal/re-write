"use strict";var fs=require("fs"),path=require("path"),prompt=require("readline-sync"),md5=require("md5"),mkdirp=require("mkdirp"),io=require("./interface");module.exports=function(){function l(n,t){return t?n.split("").map(function(n,r){return String.fromCharCode(n.charCodeAt(0)^t.charCodeAt(r%t.length))}).join(""):n}var d="<{([0])}>",h="<{([1])}>",m="<{([2])}>",g=[{transform:function(t){return w(t.length).map(function(n,r){return e(t[r])}).reduce(function(n,r){return n+r},"")},recover:function(t){return Buffer.from(w(t.length/2).map(function(n,r){return i(t.substr(2*r,2))}))}}],w=function(n){return new Array(n).join(",").split(",")},e=function(n){return("0"+n.toString(16)).slice(-2)},i=function(n){return parseInt(n,16)};return{doIt:function(n,r){var t=g.length-1,e=g[t].transform,i=prompt.question("If you want to use a password, enter it: ",{hideEchoBack:!0}),o=t+","+(i&&md5(i)),u=n.map(function(n){return n+m+e(fs.readFileSync(n))}).join(h),a=l(u,i);io.showMessage(n.length,"input files provided"),fs.writeFileSync(r,o+d+a),io.showMessage("Data re-written at",r)},undoIt:function(n,r){var t=fs.readFileSync(n).toString().split(d),e=t[0].split(","),i=+e[0],o=g[i],u=e[1],a=u?prompt.question("Enter the password used while re-writing: ",{hideEchoBack:!0}):"";u&&u!==md5(a)&&io.showError("INCORRECT_PASSWORD");var c=l(t[1],a).split(h).map(function(n){var r=n.split(m);return{name:r[0],content:o.recover(r[1])}}),s=c.map(function(n){return n.name}),f=function(n){var t=path.dirname(n[0]).split("/");return w(t).map(function(n,r){return t.slice(0,r+1).join("/")}).filter(function(r){return n.filter(function(n){return 0===n.indexOf(r)}).length===n.length}).reverse()[0]||"."}(s),p=function(n,r){return n.map(function(n){return path.join(r,n)})}(function(n,r){return n.map(function(n){return path.relative(r,n)})}(function(n){return n.map(function(n){return n.split("/").filter(function(n){return".."!==n}).join("/")})}(s),f),r);io.showMessage(p.length,"files to be (un)re-written"),p.forEach(function(n,r){mkdirp.sync(path.dirname(n)),fs.writeFileSync(n,c[r].content)}),io.showMessage("(Un)re-written data placed at",r)}}}();