"use strict";var fs=require("fs"),path=require("path"),prompt=require("readline-sync"),md5=require("md5"),mkdirp=require("mkdirp"),errors=require("./errors");module.exports=function(){var r={main:"<{([0])}>",files:"<{([1])}>",data:"<{([2])}>"},n=[{transform:function(r){return t(r.length).map(function(n,t){return e(r[t])}).reduce(function(r,n){return r+n},"")},recover:function(r){return Buffer.from(t(r.length/2).map(function(n,t){return i(r.substr(2*t,2))}))}}],t=function(r){return new Array(r).join(",").split(",")},e=function(r){return("0"+r.toString(16)).slice(-2)},i=function(r){return parseInt(r,16)},u=function(r){var n=path.dirname(r[0]).split("/");return t(n).map(function(r,t){return n.slice(0,t+1).join("/")}).filter(function(n){return r.filter(function(r){return 0===r.indexOf(n)}).length===r.length}).reverse()[0]||"."},o=function(r){return r.map(function(r){return r.split("/").filter(function(r){return".."!==r}).join("/")})},a=function(r,n){return r.map(function(r){return path.relative(n,r)})},c=function(r,n){return r.map(function(r){return path.join(n,r)})},f=function(r,n){return n?r.split("").map(function(r,t){return String.fromCharCode(r.charCodeAt(0)^n.charCodeAt(t%n.length))}).join(""):r};return{doIt:function(t,e){var i=n.length-1,u=n[i].transform,o=prompt.question("If you want to use a password, enter it: ",{hideEchoBack:!0}),a=i+","+(o&&md5(o)),c=t.map(function(n){return n+r.data+u(fs.readFileSync(n))}).join(r.files),s=f(c,o);fs.writeFileSync(e,a+r.main+s)},undoIt:function(t,e){var i=fs.readFileSync(t).toString().split(r.main),s=i[0].split(","),p=+s[0],m=n[p],l=s[1],d=l?prompt.question("Enter the password used while re-writing: ",{hideEchoBack:!0}):"";l&&l!==md5(d)&&errors.showError("INCORRECT_PASSWORD");var h=f(i[1],d).split(r.files).map(function(n){var t=n.split(r.data);return{name:t[0],content:m.recover(t[1])}}),v=h.map(function(r){return r.name}),g=u(v),w=o(v),S=a(w,g);c(S,e).forEach(function(r,n){mkdirp.sync(path.dirname(r)),fs.writeFileSync(r,h[n].content)})}}}();