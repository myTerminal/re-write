"use strict";var fs=require("fs"),path=require("path"),prompt=require("readline-sync"),md5=require("md5"),mkdirp=require("mkdirp"),io=require("./interface"),delimiters={main:"<{([0])}>",files:"<{([1])}>",data:"<{([2])}>"},transforms=[{transform:function(r){return createEmptyArray(r.length).map(function(e,t){return getHexFromByte(r[t])}).reduce(function(e,t){return e+t},"")},recover:function(r){return Buffer.from(createEmptyArray(r.length/2).map(function(e,t){return getByteFromHex(r.substr(2*t,2))}))}}],createEmptyArray=function(e){return new Array(e).join(",").split(",")},getHexFromByte=function(e){return("0"+e.toString(16)).slice(-2)},getByteFromHex=function(e){return parseInt(e,16)},getBaseDirectory=function(e){var r=path.dirname(e[0]).split("/");return createEmptyArray(r).map(function(e,t){return r.slice(0,t+1).join("/")}).filter(function(t){return e.filter(function(e){return 0===e.indexOf(t)}).length===e.length}).reverse()[0]||"."},getLiftedFilePaths=function(e){return e.map(function(e){return e.split("/").filter(function(e){return".."!==e}).join("/")})},getRelativePaths=function(e,t){return e.map(function(e){return path.relative(t,e)})},getFinalFilePaths=function(e,t){return e.map(function(e){return path.join(t,e)})},encryptOrDecryptText=function(e,r){return r?e.split("").map(function(e,t){return String.fromCharCode(e.charCodeAt(0)^r.charCodeAt(t%r.length))}).join(""):e};module.exports.doIt=function(e,t){var r=transforms.length-1,n=transforms[r].transform,i=prompt.question("If you want to use a password, enter it: ",{hideEchoBack:!0}),a=r+","+(i&&md5(i)),o=e.map(function(e){return e+delimiters.data+n(fs.readFileSync(e))}).join(delimiters.files),s=encryptOrDecryptText(o,i);io.showMessage(e.length,"input files provided"),fs.writeFileSync(t,a+delimiters.main+s),io.showMessage("Data re-written at",t)},module.exports.undoIt=function(e,t){var r=fs.readFileSync(e).toString().split(delimiters.main),n=r[0].split(","),i=+n[0],a=transforms[i],o=n[1],s=o?prompt.question("Enter the password used while re-writing: ",{hideEchoBack:!0}):"";o&&o!==md5(s)&&io.showError("INCORRECT_PASSWORD");var u=encryptOrDecryptText(r[1],s).split(delimiters.files).map(function(e){var t=e.split(delimiters.data);return{name:t[0],content:a.recover(t[1])}}),c=u.map(function(e){return e.name}),f=getBaseDirectory(c),m=getLiftedFilePaths(c),l=getRelativePaths(m,f),p=getFinalFilePaths(l,t);io.showMessage(p.length,"files to be (un)re-written"),p.forEach(function(e,t){mkdirp.sync(path.dirname(e)),fs.writeFileSync(e,u[t].content)}),io.showMessage("(Un)re-written data placed at",t)};